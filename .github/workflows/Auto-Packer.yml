name: Auto Package

on:
  push:
    branches:
    - main
    paths:
    - assets/**
    - pack.mcmeta
  workflow_dispatch: {}

jobs:
  Packer:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.message, 'chore(main): 發佈')

    steps:
      - name: Checking Repostiory
        uses: actions/checkout@v2.0.0
        with:
          fetch-depth: 0

      - name: Auto Version Change
        id: version
        run: |
          echo "::set-output name=sha_short::${GITHUB_SHA::7}"
          sed -i 's/GitVersion/git '${GITHUB_SHA::7}'/1' pack.mcmeta

      - name: Override mods
        run: |
          echo ">>> 模組翻譯覆蓋 <<<"
          echo ">>> 某些模組的翻譯如果搭配其他翻譯包"
          echo ">>> 所使用會將翻譯好的內容變成未翻譯"
          echo ">>> 此步驟將會把一些已知的模組翻譯覆蓋掉"

          echo "Override Create..."
          PATH_Create=assets/create/lang
          mkdir -p $PATH_Create
          wget https://raw.githubusercontent.com/Creators-of-Create/Create/mc1.18/dev/src/main/resources/assets/create/lang/zh_tw.json -P $PATH_Create

          echo "Override BlossomHomes..."
          PATH_BlossomHomes=assets/blossom-homes/lang
          mkdir -p $PATH_BlossomHomes
          wget https://raw.githubusercontent.com/BlossomMods/BlossomHomes/main/src/main/resources/data/blossom/lang/zh_tw.json -P $PATH_BlossomHomes

          echo "Override ProjectE..."
          PATH_ProjectE=assets/projecte/lang
          mkdir -p $PATH_ProjectE
          mkdir workdir
          cd workdir
          wget $(wget -qO - "https://www.mediafire.com/file/cso2r6ok1mu3ujw/ProjectE-1.19.2-PE1.0.0B-tw.jar" > /dev/stdout | grep 'id="downloadButton"' | grep -Po '(?<=href=")[^"]*')
          $JAVA_HOME_17_X64/bin/jar xf ProjectE-1.19.2-PE1.0.0B-tw.jar assets/projecte/lang/zh_tw.json
          cd ..
          cp workdir/assets/projecte/lang/zh_tw.json $PATH_ProjectE/
          rm -r workdir

          echo "Override BloodMagic..."
          mkdir workdir
          cd workdir
          sudo apt-get update
          sudo apt-get install -y megatools
          echo "Small Info:"
          echo "The original download link is https://mega.nz/file/vElBiCJD#vuuxCpGev25pFisNBCZXNEt3NIrqJsBkIohCzODSxHk"
          echo "But megatools look like don't know what is this"
          echo "This fix I see from https://github.com/megous/megatools/issues/157#issuecomment-615835778"
          megadl 'https://mega.nz/#!vElBiCJD!vuuxCpGev25pFisNBCZXNEt3NIrqJsBkIohCzODSxHk'
          unzip 1.18\ BloodMagic-zh_tw-v2.zip
          cd ..
          mv workdir/assets/bloodmagic assets
          rm -r workdir
          echo "Fix error space"
          sed -i 's/	//1' assets/bloodmagic/patchouli_books/guide/zh_tw/entries/altar/soul_network.json

      - name: Make TranslateModPack (1.19.x)
        uses: ComunidadAylas/PackSquash-action@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          force_include_files: LICENSE
          never_store_squash_times: true
          path: ./

      - name: DownloadArtifact (1.19.x)
        uses: actions/download-artifact@v2
        with:
          name: Optimized pack
          path: ./

      - name: Rename TranslateModPack (1.19.x)
        run: |
          mv ./pack.zip TranslateModPack-1.19.x.zip

      - name: Change pack format to 1.18.x
        run: |
          sed -i 's/9/8/1' pack.mcmeta

      - name: Make TranslateModPack (1.18.x)
        uses: ComunidadAylas/PackSquash-action@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          force_include_files: LICENSE
          never_store_squash_times: true
          path: ./

      - name: DownloadArtifact (1.18.x)
        uses: actions/download-artifact@v2
        with:
          name: Optimized pack
          path: ./

      - name: Rename TranslateModPack (1.18.x)
        run: |
          mv ./pack.zip TranslateModPack-1.18.x.zip

      - name: Delete Artifact
        uses: geekyeggo/delete-artifact@v1
        with:
          name: |
            Optimized pack

      - name: Make Checksum
        id: checksum
        run: |
          echo "::set-output name=sum-01::$(sha256sum TranslateModPack-1.19.x.zip)"
          echo "::set-output name=sum-02::$(sha256sum TranslateModPack-1.18.x.zip)"

      - name: Make Current Time
        id: current_time
        run: |
          echo "::set-output name=time::$(TZ='Asia/Taipei' date +'最後更新：%Y 年 %m 月 %d 日 %H 點 %M 分')"

      - name: Push Pack to Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "*.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: latest
          name: 模組翻譯包 (git ${{ steps.version.outputs.sha_short }})
          body: |
            ## 📝 下載
            下載下方的 Assets 內的 ``TranslateModPack.zip``
            並放入遊戲的材質包中載入即可!

            ## ⭐ 更新
            此翻譯包會在新增新內容時自動更新
            只要到這個頁面重新下載 zip 即可!

            > ${{ steps.current_time.outputs.time }}

            ## ✅ Checksum
            ```
            ${{ steps.checksum.outputs.sum-01 }}
            ${{ steps.checksum.outputs.sum-02 }}
            ```
