name: Auto Package

on:
  push:
    branches:
      - "main"
    paths:
      - "MultiVersions/**"
      - "!MultiVersions/README.md"

  pull_request:
    branches:
      - "main"
    paths:
      - "MultiVersions/**"

  workflow_dispatch: {}

permissions:
  contents: write

concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

### TODO ####
# ä»¥ versions.json ç‚ºåŸºæº– ä¸¦æ¸›å°‘å¤§å¤šæ•¸æ›´æ–°éœ€è¦è¨­å®šçš„æ±è¥¿
# å°‡ Per Release å¯«æˆå¯é‡è¤‡ä½¿ç”¨æµç¨‹

jobs:
  Packer:
    name: Packer ${{ matrix.version }}
    if: |
      contains(github.event.head_commit.message, 'chore(main): ç™¼ä½ˆ') == false &&
      github.repository == 'xMikux/ModsTranslationPack'

    strategy:
      matrix:
        version: [ 1.18.x, 1.19.x, 1.20.x ]

    uses: ./.github/workflows/ResourcePacker.yml
    with:
      matrix_version: ${{ matrix.version }}
      release: false
    secrets:
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_S3_ENDPOINT: ${{ secrets.AWS_S3_ENDPOINT }}

  Per-Releaser:
    name: Per Release
    runs-on: ubuntu-latest
    needs: [ Packer ]
    if: |
      github.event_name != 'pull_request'

    steps:
      - name: Download All Artifact
        uses: actions/download-artifact@v3

      - name: Delete All Artifact
        uses: geekyeggo/delete-artifact@v2
        with:
          name: |
            ModsTranslationPack-*

      - name: Move all zip to workdir
        run: |
          mv ModsTranslationPack-*/*.zip .

      - name: Make Checksum
        id: checksum
        run: |
          echo "sum-01=$(sha256sum ModsTranslationPack-1.20.x.zip)" >> $GITHUB_OUTPUT
          echo "sum-02=$(sha256sum ModsTranslationPack-1.19.x.zip)" >> $GITHUB_OUTPUT
          echo "sum-03=$(sha256sum ModsTranslationPack-1.18.x.zip)" >> $GITHUB_OUTPUT   

      - name: Make Current Time
        id: current_time
        run: |
          echo "time=$(TZ='Asia/Taipei' date +'æœ€å¾Œæ›´æ–°ï¼š%Y å¹´ %m æœˆ %d æ—¥ %H é» %M åˆ†')" >> $GITHUB_OUTPUT

      - name: Make Short Git SHA
        id: git_version
        run: |
          echo "sha_short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Push Pack to Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "*.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: latest-build
          allowUpdates: true
          prerelease: true
          name: æ¨¡çµ„ç¿»è­¯åŒ…æ¸¬è©¦ç‰ˆ (git ${{ steps.git_version.outputs.sha_short }})
          body: |
            ## ğŸ“ ä¸‹è¼‰æ¸¬è©¦ç‰ˆ
            ä¾ç…§ç‰ˆæœ¬ï¼Œä¸‹è¼‰ä¸‹æ–¹çš„ Assets å…§çš„ ``ModsTranslationPack.zip``
            ä¸¦æ”¾å…¥éŠæˆ²çš„è³‡æºåŒ…ä¸­è¼‰å…¥å³å¯ï¼

            ## â­ æ›´æ–°
            æ­¤ç¿»è­¯åŒ…æœƒåœ¨æ–°å¢æ–°å…§å®¹æ™‚è‡ªå‹•æ›´æ–°
            åªè¦åˆ°é€™å€‹é é¢é‡æ–°ä¸‹è¼‰ zip å³å¯ï¼

            > ${{ steps.current_time.outputs.time }}

            ## âœ… Checksum
            ```
            ${{ steps.checksum.outputs.sum-01 }}
            ${{ steps.checksum.outputs.sum-02 }}
            ${{ steps.checksum.outputs.sum-03 }}
            ```
