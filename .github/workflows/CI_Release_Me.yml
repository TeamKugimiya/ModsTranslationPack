name: Release Me

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  Release-Please:
    name: Release Please
    runs-on: ubuntu-latest
    if: github.repository == 'xMikux/ModsTranslationPack'
    steps:
      - name: Release Please
        id: release_please
        uses: google-github-actions/release-please-action@v3
        with:
          release-type: simple
          pull-request-title-pattern: "chore${scope}: ç™¼ä½ˆ${component} ${version}"
          labels: "è‡ªå‹•ç™¼ä½ˆï¼šå¾…å®š"
          release-labels: "è‡ªå‹•ç™¼ä½ˆï¼šå·²ç™¼ä½ˆ"
          changelog-types: '[{"type":"feat","section":"ðŸ’ª æ¬¡ç‰ˆæœ¬è™Ÿæå‡","hidden":false},{"type":"fix","section":"ðŸ”§ ä¿®æ­£å•é¡Œ","hidden":false},{"type":"chore","section":"ðŸ§¹ æ¸…ç†å°ˆæ¡ˆ","hidden":false},{"type":"ci","section":"â˜ï¸ æŒçºŒæ•´åˆ / æŒçºŒä½ˆç½²","hidden":false},{"type":"docs","section":"ðŸ“‘ æ–‡ä»¶æ›´æ–°","hidden":false},{"type":"mods_feat","section":"âš¡ æ–°å¢žæ¨¡çµ„ç¿»è­¯","hidden":false},{"type":"mods_update","section":"ðŸŒ æ›´æ–°æ¨¡çµ„ç¿»è­¯","hidden":false},{"type":"mods_fix","section":"ðŸ› ä¿®æ­£æ¨¡çµ„ç¿»è­¯éŒ¯èª¤","hidden":false},{"type":"mods_improve","section":"âœ¨ æå‡æ¨¡çµ„ç¿»è­¯å“è³ª","hidden":false},{"type":"mods_localize","section":"ðŸŒ ç”¨èªžåœ¨åœ°åŒ–","hidden":false}]'

    outputs:
      release_created: ${{ steps.release_please.outputs.release_created }}
      tag_name: ${{ steps.release_please.outputs.tag_name }}

  Packer:
    name: Packer ${{ matrix.version }} Version
    runs-on: ubuntu-latest
    if: ${{ needs.release-please.outputs.release_created }}
    needs: [ Release-Please ]

    strategy:
      matrix:
        version: [ 1.18.x, 1.19.x ]

    steps:
      - name: Checking Repostiory
        uses: actions/checkout@v2
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}
          fetch-depth: 0

      - name: Clean up original language file
        run: |
          rm -v assets/*/lang/en_us.json
          rm -vr assets/*/patchouli_books/*/en_us

      - name: Version Changer
        run: |
          .github/scripts/version_change.sh 2 ${{ needs.release-please.outputs.tag_name }}
          .github/scripts/version_change.sh 3 ${{ matrix.version }}

      - name: Override mods
        run: sh .github/scripts/override_mods.sh

      - name: Make ModsTranslationPack
        uses: ComunidadAylas/PackSquash-action@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          force_include_files: |
            LICENSE
            assets/tconstruct/book/**/zh_tw/*.lang
            assets/immersiveengineering/manual/zh_tw/*.txt
          never_store_squash_times: true
          path: ./
          artifact_name: OptimizedPack-${{ matrix.version }}

      - name: DownloadArtifact
        uses: actions/download-artifact@v2
        with:
          name: OptimizedPack-${{ matrix.version }}
          path: ./

      - name: Delete Artifact
        uses: geekyeggo/delete-artifact@v1
        with:
          name: |
            OptimizedPack-${{ matrix.version }}

      - name: Rename ModsTranslationPack
        run: |
          mv ./pack.zip ModsTranslationPack-${{ matrix.version }}.zip

      - name: Upload ModsTranslationPack
        uses: actions/upload-artifact@v3
        with:
          name: ModsTranslationPack-${{ matrix.version }}
          path: "*.zip"

  Release-It:
    name: Release It
    runs-on: ubuntu-latest
    needs: [ Release-Please, Packer ]

    steps:
      - name: Download All Artifact
        uses: actions/download-artifact@v3

      - name: Delete All Artifact
        uses: geekyeggo/delete-artifact@v1
        with:
          name: |
            ModsTranslationPack-1.18.x
            ModsTranslationPack-1.19.x

      - name: Move all zip to workdir
        run: |
          mv ModsTranslationPack-*/*.zip .

      - name: Make Checksum
        run: |
          SUM0=$(sha256sum ModsTranslationPack-1.19.x.zip)
          SUM1=$(sha256sum ModsTranslationPack-1.18.x.zip)
          echo -e "$SUM0\n$SUM1" > checksums.txt

      - name: Make Changelog
        id: changelog
        run: |
          Tags=${{ needs.release-please.outputs.tag_name }}
          CHANGELOG=$(cat << EOF
          $(curl https://api.github.com/repos/xMikux/ModsTranslationPack/releases/tags/$Tags -H "Accept: application/vnd.github+json" | jq -r .body)
          EOF
          )
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Upload ModsTranslationPacks
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            *.zip
            checksums.txt
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Modrinth (1.18.x)
        uses: Kir-Antipov/mc-publish@v3.2
        with:
          modrinth-id: cF5VXmkW
          modrinth-unfeature-mode: subset
          name: æ¨¡çµ„ç¿»è­¯åŒ… 1.18.x ${{ needs.release-please.outputs.tag_name }}
          version: ${{ needs.release-please.outputs.tag_name }}
          changelog: |
            ${{ env.CHANGELOG }}
          loaders: minecraft
          game-versions: |
            1.18
            1.18.1
            1.18.2
          files-primary: ModsTranslationPack-1.18.x.zip
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

      - name: Publish to Modrinth (1.19.x)
        uses: Kir-Antipov/mc-publish@v3.2
        with:
          modrinth-id: cF5VXmkW
          modrinth-unfeature-mode: subset
          name: æ¨¡çµ„ç¿»è­¯åŒ… 1.19.x ${{ needs.release-please.outputs.tag_name }}
          version: ${{ needs.release-please.outputs.tag_name }}
          changelog: |
            ${{ env.CHANGELOG }}
          loaders: minecraft
          game-versions: |
            1.19
            1.19.1
            1.19.2
          files-primary: ModsTranslationPack-1.19.x.zip
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
